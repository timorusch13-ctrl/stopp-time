<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stopp-Spiel Final</title>
    <style>
        /* CSS-Code beginnt hier */
        :root {
            --primary-color: #00ff99; /* Standard-Akzentfarbe (Gr√ºn) */
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --stop-color: #ff4d4d;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .game-container {
            position: relative;
            text-align: center;
            padding: 30px;
            border-radius: 20px;
            background-color: var(--card-bg);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 450px;
        }

        /* Obere Icon-Buttons Container */
        .icon-buttons {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }
        #helpButton {
            position: absolute;
            top: 15px;
            left: 15px;
        }
        .icon-buttons button, #helpButton {
            background: none; border: none; color: var(--text-color);
            font-size: 1.5em; cursor: pointer; opacity: 0.7;
        }
        .icon-buttons button:hover, #helpButton:hover { opacity: 1; }

        h1 { margin-top: 0; color: var(--primary-color); }

        #display {
            height: 100px; 
            margin: 30px auto; 
            border: 5px solid var(--primary-color); 
            border-radius: 50px; 
            display: flex; 
            justify-content: center;
            align-items: center; 
            font-weight: bold;
            color: var(--primary-color);
            
            font-size: 3.5em; 
            text-align: center; 
            white-space: nowrap; 
            padding: 0 15px; 
            box-sizing: border-box;
            overflow: hidden; 
            
            transition: width 0.4s ease, font-size 0.3s ease; 
        }

        .precision-1 { width: 150px; font-size: 3.5em; } 
        .precision-2 { width: 180px; font-size: 3.5em; } 
        .precision-3 { width: 220px; font-size: 3.5em; } 
        .precision-4 { width: 280px; font-size: 2.1em; } 
        .precision-5 { width: 340px; font-size: 1.7em; } 


        #actionButton {
            padding: 15px 30px; font-size: 1.2em; cursor: pointer;
            background-color: var(--primary-color); border: none;
            border-radius: 50px; color: var(--card-bg); width: 100%;
            box-sizing: border-box;
            margin-top: 20px; 
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        #actionButton.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none; 
            position: absolute; 
        }

        #message { margin-top: 25px; font-size: 1em; color: var(--stop-color); min-height: 1.2em; }

        .slider-container {
            display: none; 
            width: 100%; background-color: #444; border-radius: 50px;
            margin-top: 20px; 
            overflow: hidden; position: relative; height: 50px;
            cursor: grab; user-select: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .slider-container.visible {
            opacity: 1;
            display: block; 
        }
        
        .slider-label {
            position: absolute; top: 0; left: 0; right: 0; text-align: center;
            line-height: 50px; color: #ccc; pointer-events: none; font-size: 0.9em;
            z-index: 0; 
        }
        .slider-button {
            width: 50px; height: 50px; background-color: var(--primary-color); 
            border-radius: 50%; position: absolute; top: 0; 
            display: flex;
            align-items: center; justify-content: center; color: var(--card-bg);
            font-weight: 900; font-size: 1.5em; 
            cursor: inherit; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1; 
            transition: transform 0s !important; 
        }
        
        .slider-container.dir-right .slider-button { left: 0; }
        .slider-container.dir-left .slider-button { right: 0; }

        /* --- Modal CSS --- */
        .modal {
            display: none; position: fixed; z-index: 1; left: 0; top: 0;
            width: 100%; height: 100%; 
            /* Halb durchsichtiger schwarzer Hintergrund */
            background-color: rgba(0, 0, 0, 0.6); 
            justify-content: center; align-items: center;
        }
        .modal-content {
            /* Hintergrund des inneren Men√ºs ist wieder blickdicht */
            background-color: var(--card-bg); 
            padding: 20px; border-radius: 20px; width: 80%; max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .close-button {
            color: var(--text-color); float: right; font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .setting-option { margin-bottom: 15px; }
        .color-picker-container button {
            width: 30px; height: 30px; border-radius: 80%; border: 2px solid transparent; margin: 5px; cursor: pointer;
        }
        .color-picker-container button.active {
            border-color: white; box-shadow: 0 0 0 2px var(--card-bg);
        }
        #highscoreList { list-style-type: none; padding: 0; }
        #highscoreList li {
            padding: 10px; background-color: #2c2c2c; margin-bottom: 5px;
            border-radius: 20px; display: flex; justify-content: space-between;
        }

        .direction-buttons button, .precision-buttons button {
            padding: 10px 15px;
            margin: 5px 2px;
            border: 2px solid #555;
            background-color: #333;
            color: var(--text-color);
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .direction-buttons button.active, .precision-buttons button.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--card-bg);
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="game-container">
        <button id="helpButton" aria-label="Spielanleitung">?</button>
        <div class="icon-buttons">
            <button id="scoreButton" aria-label="Highscore anzeigen">üèÜ</button>
            <button id="settingsButton" aria-label="Einstellungen √∂ffnen">‚öôÔ∏è</button>
        </div>
        
        <h1>Stopp-Spiel</h1>
        <div id="display" class="precision-2">0.00s</div>
        
        <button id="actionButton">Start</button>

        <div class="slider-container" id="sliderContainer">
            <div class="slider-button" id="sliderButton">‚Üí</div>
            <span class="slider-label" id="sliderLabel">Zum Neustart schieben</span>
        </div>
        
        <p id="message"></p>
    </div>

    <!-- Modal Einstellungen -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeSettingsModal">&times;</span>
            <h2>Einstellungen</h2>
            
            <div class="setting-option">
                <label>Nachkommastellen:</label>
                <div class="precision-buttons">
                    <button data-precision="1">1</button>
                    <button data-precision="2" class="active">2</button>
                    <button data-precision="3">3</button>
                    <button data-precision="4">4</button>
                    <button data-precision="5">5</button>
                </div>
            </div>

            <div class="setting-option">
                <label>Akzentfarbe:</label>
                <div class="color-picker-container">
                    <button data-color="#00ff99" style="background-color: #00ff99;" class="active"></button>
                    <button data-color="#4da6ff" style="background-color: #4da6ff;"></button> <!-- Blau -->
                    <button data-color="#ff4d4d" style="background-color: #ff4d4d;"></button> <!-- Rot -->
                    <button data-color="#ffcc00" style="background-color: #ffcc00;"></button> <!-- Gelb -->
                </div>
            </div>

            <div class="setting-option">
                <label>Schieberichtung Neustart:</label>
                <div class="direction-buttons">
                    <button data-direction="right" class="active">Rechts ‚Üí</button>
                    <button data-direction="left">‚Üê Links</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Highscores -->
    <div id="scoreModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeScoreModal">&times;</span>
            <h2>Highscores</h2>
            <ul id="highscoreList">
                <!-- Highscores werden hier dynamisch hinzugef√ºgt -->
            </ul>
        </div>
    </div>

    <!-- Modal Hilfe -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeHelpModal">&times;</span>
            <h2>Spielanleitung</h2>
            <p><strong>Ziel:</strong> Stoppe den Timer so nah wie m√∂glich an einer ganzen Sekunde (z.B. 5.00s, 10.00s, etc.).</p>
            <p><strong>Punkte:</strong> Je genauer du bist, desto mehr Punkte gibt es.</p>
            <p><strong>Einstellungen:</strong> Du kannst die Anzahl der Nachkommastellen und die Farbe anpassen.</p>
        </div>
    </div>

    <script>
        // JavaScript-Code beginnt hier
        const display = document.getElementById('display');
        const actionButton = document.getElementById('actionButton');
        const sliderContainer = document.getElementById('sliderContainer');
        const sliderButton = document.getElementById('sliderButton');
        const sliderLabel = document.getElementById('sliderLabel');
        const messagePara = document.getElementById('message');
        const rootStyles = document.documentElement.style;

        let startTime;
        let animationFrameId;
        let isRunning = false;
        let settings = {
            precision: 2, 
            color: '#00ff99',
            direction: 'right'
        };
        let highscores = JSON.parse(localStorage.getItem('stoppspielHighscores')) || [];
        
        // --- Timer Logik ---
        function toggleGame() {
            if (isRunning) {
                stopGame();
            } else {
                startGame();
            }
        }

        function startGame() {
            if (isRunning) return;
            isRunning = true;
            startTime = performance.now();
            actionButton.textContent = 'Stop';
            messagePara.textContent = '';
            animationFrameId = requestAnimationFrame(updateDisplayLoop);
        }

        function stopGame() {
            if (!isRunning) return;
            isRunning = false;
            cancelAnimationFrame(animationFrameId);
            
            const elapsedTime = performance.now() - startTime;
            const formattedTime = formatTime(elapsedTime, settings.precision);
            display.textContent = formattedTime;

            calculateScore(elapsedTime);
            showRestartSlider();
        }

        function updateDisplayLoop(timestamp) {
            const elapsedTime = timestamp - startTime;
            display.textContent = formatTime(elapsedTime, settings.precision);
            animationFrameId = requestAnimationFrame(updateDisplayLoop);
        }

        function formatTime(ms, precision) {
            const seconds = ms / 1000;
            return seconds.toFixed(precision) + 's';
        }

        function calculateScore(elapsedTime) {
            const seconds = elapsedTime / 1000;
            const decimalPart = seconds % 1; 
            const distanceFromTarget = Math.min(decimalPart, 1 - decimalPart);
            let score = 0;
            let message = '';

            if (distanceFromTarget < 0.005) { 
                score = 500;
                message = "Perfekt! üéâ 500 Punkte!";
            } else if (distanceFromTarget < 0.01) { 
                score = 200;
                message = "Sehr gut! 200 Punkte!";
            } else if (distanceFromTarget < 0.05) { 
                score = 50;
                message = "Gut gemacht! 50 Punkte!";
            } else {
                score = 0;
                message = "Versuch's nochmal!";
            }

            messagePara.textContent = message;
            if (score > 0) {
                saveHighscore(seconds.toFixed(settings.precision), score);
            }
        }

        // --- Einstellungs- und UI Logik ---

        function applySettings() {
            rootStyles.setProperty('--primary-color', settings.color);
            sliderContainer.classList.remove('dir-left', 'dir-right');
            sliderContainer.classList.add(`dir-${settings.direction}`);
            sliderButton.textContent = settings.direction === 'right' ? '‚Üí' : '‚Üê';
            sliderLabel.textContent = settings.direction === 'right' ? 'Zum Neustart schieben' : '‚Üê Zum Neustart schieben';

            display.classList.remove('precision-1', 'precision-2', 'precision-3', 'precision-4', 'precision-5');
            display.classList.add(`precision-${settings.precision}`);
            
            if (!isRunning) {
                 display.textContent = formatTime(0, settings.precision);
            }
        }

        // Slider Logik
        let isDragging = false;
        const startDragging = (e) => {
            if (!isRunning) {
                isDragging = true;
                sliderButton.style.transition = 'none'; 
                document.body.style.cursor = 'grabbing';
            }
        };

        const stopDragging = (e) => {
            if (isDragging) {
                isDragging = false;
                sliderButton.style.transition = ''; 
                document.body.style.cursor = 'default';
                const containerRect = sliderContainer.getBoundingClientRect();
                const buttonRect = sliderButton.getBoundingClientRect();
                const threshold = containerRect.width * 0.8;
                let movedDistance;

                if (settings.direction === 'right') {
                    movedDistance = buttonRect.left - containerRect.left;
                    if (movedDistance >= threshold) {
                        resetGame();
                    } else {
                        sliderButton.style.transform = 'translateX(0px)';
                    }
                } else {
                    movedDistance = containerRect.right - buttonRect.right;
                    if (movedDistance >= threshold) {
                        resetGame();
                    } else {
                        sliderButton.style.transform = 'translateX(0px)';
                    }
                }
            }
        };

        const drag = (e) => {
            if (!isDragging) return;

            e.preventDefault();
            const clientX = e.touches ? e.touches.clientX : e.clientX;
            const containerRect = sliderContainer.getBoundingClientRect();
            const buttonRect = sliderButton.getBoundingClientRect();
            
            let newPos;

            if (settings.direction === 'right') {
                 const maxMove = containerRect.width - buttonRect.width;
                 newPos = clientX - containerRect.left - (buttonRect.width / 2);
                 newPos = Math.max(0, Math.min(maxMove, newPos));
                 sliderButton.style.transform = `translateX(${newPos}px)`;
            } else {
                const maxMove = containerRect.width - buttonRect.width;
                const relativeX = clientX - containerRect.left; 
                const buttonCenterX = relativeX - (buttonRect.width / 2);
                
                newPos = maxMove - buttonCenterX;
                newPos = Math.max(0, Math.min(maxMove, newPos));

                const translateXValue = -(maxMove - newPos);
                sliderButton.style.transform = `translateX(${translateXValue}px)`;
            }
        };
        
        function showRestartSlider() {
            actionButton.classList.add('hidden');
            sliderContainer.classList.add('visible');
            sliderButton.style.transform = 'translateX(0px)';
        }

        function resetGame() {
            isRunning = false;
            display.textContent = formatTime(0, settings.precision);
            actionButton.textContent = 'Start';
            actionButton.classList.remove('hidden');
            sliderContainer.classList.remove('visible');
            messagePara.textContent = '';
        }

        // Modal Logik
        const settingsModal = document.getElementById('settingsModal');
        const scoreModal = document.getElementById('scoreModal');
        const helpModal = document.getElementById('helpModal');
        
        document.getElementById('settingsButton').onclick = () => { settingsModal.style.display = 'flex'; };
        document.getElementById('closeSettingsModal').onclick = () => { settingsModal.style.display = 'none'; };
        document.getElementById('scoreButton').onclick = () => { 
            displayHighscores();
            scoreModal.style.display = 'flex'; 
        };
        document.getElementById('closeScoreModal').onclick = () => { scoreModal.style.display = 'none'; };
        document.getElementById('helpButton').onclick = () => { helpModal.style.display = 'flex'; };
        document.getElementById('closeHelpModal').onclick = () => { helpModal.style.display = 'none'; };

        // Event Listener f√ºr Einstellungen speichern
        document.querySelector('.precision-buttons').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                settings.precision = parseInt(e.target.dataset.precision);
                document.querySelectorAll('.precision-buttons button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                applySettings(); 
            }
        });

        document.querySelector('.color-picker-container').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                settings.color = e.target.dataset.color;
                document.querySelectorAll('.color-picker-container button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                applySettings();
            }
        });

         document.querySelector('.direction-buttons').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                settings.direction = e.target.dataset.direction;
                document.querySelectorAll('.direction-buttons button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                applySettings();
            }
        });

        // Highscore Logik
        function saveHighscore(time, score) {
            highscores.push({ time, score, date: new Date().toLocaleDateString() });
            highscores.sort((a, b) => b.score - a.score || parseFloat(a.time) - parseFloat(b.time));
            highscores = highscores.slice(0, 10); 
            localStorage.setItem('stoppspielHighscores', JSON.stringify(highscores));
        }

        function displayHighscores() {
            const list = document.getElement